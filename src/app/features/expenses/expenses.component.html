<div class='container'>
  <app-expense-summary />

  <div class="header">
    <h2>Expenses</h2>
    @if (!isAdmin()) {
    <p-button (click)="openAddExpenseForm()">
      <i class="pi pi-plus"></i> New Expense
    </p-button>
    }
  </div>

  <p-selectbutton
    [options]="statusOptions"
    (onChange)="onStatusChange($event.value)"
    [(ngModel)]="status"
    optionLabel="label"
    optionValue="value"
    aria-labelledby="label"
  />

  <p-table
      [tableStyle]="{ 'min-width': '50rem' }"
      [value]="expenses()?.slice(0, limit()) ?? []"
      [loading]="loading() || !!(dataFetchingError())"
      [showLoader]="false"
      sortMode='single'
      sortField='createdAt'
      [sortOrder]="-1"
  >
    <ng-template #header>
      <tr>
        <th pSortableColumn="createdAt" style="width:13%">
          Requested On <p-sortIcon field="createdAt" />
        </th>
        <th style="width:13%">Purpose</th>
        <th style="width:10%">Expense</th>
        <th style="width:10%">Status</th>
        <th style="width:12%">Type</th>
        <th style="width:32%">Description</th>
        <th style="width:10%">Actions</th>
      </tr>
    </ng-template>
    <ng-template #loadingbody>
<tr>
        <td [colSpan]="7">
          <div class='loading-body'>
        @if(dataFetchingError()) {
          <p-message severity="error" size="small" variant="simple">
            {{ dataFetchingError() }}
          </p-message>
        }
        @if(loading()) {
            <app-spinner />
        }
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template #body let-expense>
      <tr>
        <td>{{ expense.createdAt | date:"medium" }}</td>
        <td>{{ expense.purpose }}</td>
        <td>{{ expense.amount }}</td>
        <td>
          <p-tag [value]="expense.status" [severity]="getSeverity(expense.status)" [rounded]="true" />
        </td>
        <td>
          @if (expense.isReconciled) {
            <p-tag value="Reconciliation" severity="info" [rounded]="true" />
          } @else {
            <p-tag value="Expense" severity="secondary" [rounded]="true" />
          }
        </td>
        <td>
          <span class="description" [pTooltip]="expense.description" tooltipPosition="top">
            {{ expense.description }}
          </span>
        </td>
        <td>
          <p-button
            icon="pi pi-eye"
            [text]="true"
            [rounded]="true"
            pTooltip="View Details"
            tooltipPosition="top"
            (click)="openExpenseDetails(expense)"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  @if (!loading() && expenses()?.length === 0) {
    <div class="empty-state">
      <i class="pi pi-briefcase"></i>
      <h3>No Expenses Yet</h3>
      @if (!isAdmin()) {
        <p>Get started by adding your first expense request.</p>
        <p-button
          [label]="'Expenses'"
          icon="pi pi-plus"
          (onClick)="openAddExpenseForm()"
          styleClass="p-button-primary mt-3">
        </p-button>
      }
    </div>
  }

  @if(totalRecords()) {
  <p-paginator
    [totalRecords]="totalRecords()"
    [rows]="limit()"
    (onPageChange)="onPageChange($event)"
  />
  }

  <app-new-expense-form
    [(visible)]="openNewExpenseForm"
    (onAddExpense)="addNewExpense($event)"
  />

  <app-expense-details-modal
    [(visible)]="openExpenseDetailsModal"
    [expense]="selectedExpense()"
    [isAdmin]="isAdmin()"
    (onStatusChange)="onExpenseStatusChange($event)"
  />
</div>
