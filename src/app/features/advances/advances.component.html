<div class='container'>
  <app-advance-summary />

  <div class="header">
    <h2>Advances</h2>
    @if (!isAdmin()) {
    <p-button (click)="openAddAdvanceForm()">
      <i class="pi pi-plus"></i> New Advance
    </p-button>
    }
  </div>

  <p-selectbutton
    [options]="statusOptions"
    (onChange)="onStatusChange($event.value)"
    [(ngModel)]="status"
    optionLabel="label"
    optionValue="value"
    aria-labelledby="label"
  />

  <p-table
      [tableStyle]="{ 'min-width': '50rem' }"
      [value]="advances()?.slice(0, limit()) ?? []"
      [loading]="loading() || !!(dataFetchingError())"
      [showLoader]="false"
      sortMode='single'
      sortField='createdAt'
      [sortOrder]="-1"
  >
    <ng-template #header>
      <tr>
        <th pSortableColumn="createdAt" style="width:13%">
          Requested On <p-sortIcon field="createdAt" />
        </th>
        <th style="width:13%">Purpose</th>
        <th style="width:10%">Advance</th>
        <th style="width:10%">Status</th>
        <th style="width:12%">Reconciliation</th>
        <th style="width:32%">Description</th>
        <th style="width:10%">Actions</th>
      </tr>
    </ng-template>
    <ng-template #loadingbody>
      <tr>
        <td [colSpan]="7">
          <div class='loading-body'>
        @if(dataFetchingError()) {
          <p-message severity="error" size="small" variant="simple">
            {{ dataFetchingError() }}
          </p-message>
        }
        @if(loading()) {
            <app-spinner />
        }
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template #body let-advance>
      <tr>
        <td>{{ advance.createdAt | date:"medium" }}</td>
        <td>{{ advance.purpose }}</td>
        <td>{{ advance.amount }}</td>
        <td>
          <p-tag [value]="advance.status" [severity]="getSeverity(advance.status)" [rounded]="true" />
        </td>
        <td>
          @if (advance.reconciledExpenseId) {
            <p-tag value="Reconciled" severity="info" [rounded]="true" icon="pi pi-check" />
          } @else {
            <span class="not-reconciled">-</span>
          }
        </td>
        <td>
          <span class="description" [pTooltip]="advance.description" tooltipPosition="top">
            {{ advance.description }}
          </span>
        </td>
        <td>
          <p-button
            icon="pi pi-eye"
            [text]="true"
            [rounded]="true"
            pTooltip="View Details"
            tooltipPosition="top"
            (click)="openAdvanceDetails(advance)"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  @if (!loading() && advances()?.length === 0) {
    <div class="empty-state">
      <i class="pi pi-briefcase"></i>
      <h3>No Advances Yet</h3>
      @if (!isAdmin()) {
        <p>Get started by adding your first advance request.</p>
        <p-button
          [label]="'Advances'"
          icon="pi pi-plus"
          (onClick)="openAddAdvanceForm()"
          styleClass="p-button-primary mt-3">
        </p-button>
      }
    </div>
  }

  @if(totalRecords()) {
  <p-paginator
    [totalRecords]="totalRecords()"
    [rows]="limit()"
    (onPageChange)="onPageChange($event)"
  />
  }

  <app-new-advance-form
    [(visible)]="openNewAdvanceForm"
    (onAddAdvance)="addNewAdvance($event)"
  />

  <app-advance-details-modal
    [(visible)]="openAdvanceDetailsModal"
    [advance]="selectedAdvance()"
    [isAdmin]="isAdmin()"
    (onStatusChange)="onAdvanceStatusChange($event)"
    (onReconcile)="onReconcileAdvance($event)"
  />

  <app-new-expense-form
    [(visible)]="openReconciliationExpenseForm"
    [advanceId]="reconciliationAdvanceId()"
    (onAddExpense)="onReconciliationExpenseAdded($event)"
  />
</div>
